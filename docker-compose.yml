name: servelogic-app
services:
  # ArangoDB Database
  arangodb:
    image: arangodb:3.11
    container_name: servelogic_arangodb
    ports:
      - "8529:8529"
    environment:
      ARANGO_ROOT_PASSWORD: root
    volumes:
      - servelogic_arangodb_data:/var/lib/arangodb3
    networks:
      - servelogic-network
    healthcheck:
      test: ["CMD", "sh", "-c", "wget --spider http://127.0.0.1:8529/_api/version 2>&1 | grep -q '401\\|200'"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    #Limits for testing
    deploy:
      resources:
        limits:
          memory: 1G
  
  # TDB Store - Jena Fuseki
  fuseki:
    image: stain/jena-fuseki
    ports:
      - "3030:3030"
    container_name: servelogic_fuseki
    networks:
      - servelogic-network
    environment:
      - ADMIN_PASSWORD=admin
      - JVM_ARGS=-Xmx800m
    volumes:
      - servelogic_fuseki_data:/fuseki
    command: >
      sh -c "
      echo 'Enforcing login by default..' &&
      sed -i 's|/\$/** = localhostFilter|/\$/** = authcBasic,user[admin]|g' /jena-fuseki/shiro.ini &&
      /jena-fuseki/fuseki-server
      "
    healthcheck:
      test: ["CMD", "sh", "-c", "wget --spider http://127.0.0.1:3030/ 2>&1 | grep -q '401\\|200'"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    #Limits for testing
    deploy:
      resources:
        limits:
          memory: 1G


  # ServeLogic API Backend
  servelogic-api:
    build:
      context: ./app/servelogic-api
      dockerfile: Dockerfile
    container_name: servelogic_api
    ports:
      - "7999:7999"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - ARANGODB_HOST=arangodb
      - ARANGODB_PORT=8529
      - ARANGODB_DATABASE=servelogic
      - ARANGODB_USER=root
      - ARANGODB_PASSWORD=root
      - FUSEKI_HOST=fuseki
      - FUSEKI_PORT=3030
      - FUSEKI_DATASET=servelogic
      - FUSEKI_USER=admin
      - FUSEKI_PASSWORD=admin
    depends_on:
      arangodb:
        condition: service_healthy
    networks:
      - servelogic-network
    restart: unless-stopped
    #Limits for testing
    deploy:
      resources:
        limits:
          memory: 1G

  # CMS Frontend Application
  cms:
    build:
      context: ./app/cms
      dockerfile: Dockerfile
    container_name: servelogic_cms
    ports:
      - "7998:7998"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - API_BASE_URL=http://servelogic-api:7999
    depends_on:
      - servelogic-api
    networks:
      - servelogic-network
    restart: unless-stopped
    #Limits for testing
    deploy:
      resources:
        limits:
          memory: 1G

  # Ordering Frontend Application
  ordering:
    build:
      context: ./app/ordering
      dockerfile: Dockerfile
    container_name: servelogic_ordering
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - API_BASE_URL=http://servelogic-api:7999
    depends_on:
      - servelogic-api
    networks:
      - servelogic-network
    restart: unless-stopped
    #Limits for testing
    deploy:
      resources:
        limits:
          memory: 1G

volumes:
  servelogic_arangodb_data:
    driver: local
  servelogic_fuseki_data:
    driver: local

networks:
  servelogic-network:
    driver: bridge
